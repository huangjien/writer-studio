version: "3.8"

services:
  api:
    build: .
    container_name: writer-studio-api
    environment:
      NOVEL_EVAL_PROVIDER: ${NOVEL_EVAL_PROVIDER:-openai}
      NOVEL_EVAL_MODEL: ${NOVEL_EVAL_MODEL:-gpt-4o-mini}
      NOVEL_EVAL_LANG: ${NOVEL_EVAL_LANG:-zh-CN}
      NOVEL_EVAL_LOG_LEVEL: ${NOVEL_EVAL_LOG_LEVEL:-INFO}
      NOVEL_EVAL_DB_PATH: /data/evals.db
      OLLAMA_HOST: ${OLLAMA_HOST:-http://ollama:11434}
    volumes:
      - ./data:/data
    networks:
      - appnet
    depends_on:
      - ollama
    # No external port mapping; API is only reachable via nginx

  nginx:
    image: nginx:alpine
    container_name: writer-studio-nginx
    ports:
      - "443:443"
    volumes:
      - ./nginx-ssl.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certs:/etc/nginx/certs:ro
    depends_on:
      - api
    networks:
      - appnet

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    # No external port mapping in production
    networks:
      - appnet

networks:
  appnet:
    driver: bridge